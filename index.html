<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cantor Building Level 3 | SHU Navigation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        :root {
            --primary: #C2185B; --primary-light: #E91E63; --primary-dark: #880E4F;
            --success: #00C853; --danger: #FF5252; --light: #F9F9F9; --dark: #2C2C2C;
            --gray: #666; --white: #FFFFFF; --transition: all 0.3s ease;
        }
        
        body { background: #f5f5f5; color: var(--dark); min-height: 100vh; }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white; padding: 16px 20px; display: flex; align-items: center;
            position: sticky; top: 0; z-index: 1000; border-bottom: 4px solid var(--primary);
        }
        
        .logo-icon {
            width: 40px; height: 40px; background: white; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: var(--primary); font-size: 20px; margin-right: 12px;
        }
        
        /* Layout */
        .main-container {
            display: flex; flex-direction: column; height: calc(100vh - 80px);
            padding: 15px; gap: 15px; width: 100%; overflow: hidden;
        }
        
        @media (min-width: 992px) {
            .main-container { flex-direction: row; height: calc(100vh - 90px); padding: 20px; gap: 20px; }
        }
        
        /* Left Panel */
        .left-panel {
            width: 100%; display: flex; flex-direction: column; gap: 15px;
            overflow-y: auto; max-height: 40vh;
        }
        
        @media (min-width: 992px) {
            .left-panel { width: 380px; min-width: 380px; height: 100%; max-height: 100%; }
        }
        
        /* Cards & Forms */
        .card {
            background: white; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            padding: 20px; border: 1px solid rgba(0,0,0,0.05);
        }
        
        .card-header {
            display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
            padding-bottom: 15px; border-bottom: 2px solid rgba(194, 24, 91, 0.1);
        }
        
        .card-header i { color: var(--primary); font-size: 1.2rem; }
        .card-header h3 { color: var(--primary-dark); font-size: 1.2rem; font-weight: 600; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); }
        
        select {
            width: 100%; padding: 14px 16px; border-radius: 12px; border: 2px solid #e5e7eb;
            font-size: 0.95rem; background: white; color: var(--dark); cursor: pointer;
            appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23C2185B' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 16px center; background-size: 16px;
        }
        
        select:focus { outline: none; border-color: var(--primary); }
        
        /* Buttons */
        .btn {
            padding: 14px 20px; border-radius: 12px; border: none; font-weight: 600;
            cursor: pointer; transition: var(--transition); display: flex;
            align-items: center; justify-content: center; gap: 10px; width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; box-shadow: 0 4px 15px rgba(194, 24, 91, 0.3);
        }
        
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(194, 24, 91, 0.4); }
        .btn-secondary { background: white; color: var(--dark); border: 2px solid #e5e7eb; }
        .btn-secondary:hover { background: #f8fafc; border-color: var(--primary); transform: translateY(-2px); }
        
        .button-group { display: flex; gap: 12px; margin-top: 20px; }
        
        /* Quick destinations */
        .quick-destinations {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 16px;
        }
        
        .quick-dest {
            padding: 10px 8px; background: white; border: 2px solid #e5e7eb; border-radius: 10px;
            font-size: 0.8rem; cursor: pointer; transition: var(--transition); text-align: center;
        }
        
        .quick-dest:hover { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Path info */
        .path-info {
            background: linear-gradient(135deg, rgba(194, 24, 91, 0.08), rgba(194, 24, 91, 0.04));
            padding: 15px; border-radius: 14px; margin-top: 20px; display: none;
        }
        
        .path-info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .path-info-item { text-align: center; }
        .path-info-value { font-size: 1.3rem; font-weight: 700; color: var(--primary); }
        .path-info-label { font-size: 0.75rem; color: var(--gray); }
        
        /* Status message */
        .status-message {
            background: linear-gradient(135deg, rgba(194, 24, 91, 0.08), rgba(194, 24, 91, 0.04));
            padding: 12px 16px; border-radius: 12px; margin-top: 15px;
            font-size: 0.9rem; color: var(--dark); text-align: center; display: none;
        }
        
        /* Right Panel - Map */
        .right-panel {
            flex: 1; display: flex; flex-direction: column; height: 60vh;
            min-height: 300px; width: 100%; overflow: hidden;
        }
        
        @media (min-width: 992px) { .right-panel { height: 100%; min-height: auto; } }
        
        .map-container {
            flex: 1; background: white; border-radius: 16px; overflow: hidden;
            display: flex; flex-direction: column; position: relative;
            border: 2px solid var(--primary); width: 100%; height: 100%;
        }
        
        .map-header {
            padding: 15px 20px; background: linear-gradient(to right, rgba(194, 24, 91, 0.1), white);
            border-bottom: 1px solid rgba(194, 24, 91, 0.1); display: flex;
            justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        
        .map-controls { display: flex; gap: 8px; }
        
        .map-control-btn {
            width: 36px; height: 36px; border-radius: 8px; background: white;
            border: 2px solid #e5e7eb; color: var(--gray); cursor: pointer;
            transition: var(--transition); display: flex; align-items: center; justify-content: center;
        }
        
        .map-control-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Map area */
        .map-area {
            flex: 1; position: relative; overflow: hidden; background: #f5f5f5;
            cursor: grab; width: 100%; height: 100%;
        }
        
        .map-area:active { cursor: grabbing; }
        
        .map-content {
            position: absolute; top: 0; left: 0; width: 1550px; height: 750px;
            background: #f5f5f5; transform-origin: 0 0; transition: transform 0.1s ease;
        }
        
        /* Rooms */
        .room {
            position: absolute; background: white; border: 2px solid var(--primary);
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
            padding: 2px; font-weight: 600; text-align: center; z-index: 5;
            transition: var(--transition); overflow: hidden; font-size: 11px;
            color: #333; min-height: 20px;
        }
        
        .room:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 25; }
        
        /* Room types */
        .elevator { background: #e3f2fd; border-radius: 6px; color: #0d47a1; }
        .stairs { background: #f5f5f5; border-radius: 6px; color: #424242; }
        .toilet { background: #e8f5e9; border-radius: 6px; color: #1b5e20; }
        
        /* Start/end rooms */
        .start-room { border-color: var(--success) !important; border-width: 3px; }
        .end-room { border-color: var(--danger) !important; border-width: 3px; }
        
        /* Path line */
        .path-line {
            position: absolute; background: linear-gradient(90deg, var(--primary), var(--primary-light));
            height: 10px; border-radius: 5px; z-index: 30; pointer-events: none;
            transform-origin: 0 0; box-shadow: 0 0 0 3px rgba(255,255,255,0.9), 0 0 20px rgba(194,24,91,0.7);
        }
        
        /* Hallways & Windows */
        .hallway { position: absolute; background: transparent; z-index: 1; border-radius: 4px; }
        .window { position: absolute; background: rgba(173,216,230,0.3); border: 2px solid #d1ccc0; z-index: 6; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header { padding: 12px 15px; }
            .logo-icon { width: 36px; height: 36px; font-size: 18px; }
            .main-container { height: calc(100vh - 76px); padding: 12px; gap: 12px; }
            .left-panel { max-height: 35vh; }
            .right-panel { height: 65vh; }
            .card { padding: 16px; }
            .button-group { flex-direction: column; }
            .quick-destinations { grid-template-columns: repeat(2, 1fr); }
            .room { font-size: 9px; border-width: 1.5px; }
            .map-header { padding: 12px 15px; }
            .map-control-btn { width: 32px; height: 32px; }
        }
        
        @media (max-width: 480px) { .quick-destinations { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-icon"><i class="fas fa-map-marked-alt"></i></div>
        <div>
            <h1 style="font-size: 1.2rem; color: white; margin-bottom: 3px;">Cantor Building Level 3</h1>
            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">Sheffield Hallam University Indoor Navigation</div>
        </div>
    </header>
    
    <main class="main-container">
        <div class="left-panel">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-route"></i>
                    <h3>Find Your Route</h3>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-map-marker-alt"></i> Start Location</label>
                    <select id="start-room">
                        <option value="">Select starting point</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-flag-checkered"></i> Destination</label>
                    <select id="end-room">
                        <option value="">Select destination</option>
                    </select>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="find-path">
                        <i class="fas fa-directions"></i> Find Route
                    </button>
                    <button class="btn btn-secondary" id="clear-path">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
                
                <div class="status-message" id="status-message"></div>
                
                <div class="path-info" id="path-info">
                    <div class="path-info-grid">
                        <div class="path-info-item">
                            <div class="path-info-value" id="total-distance">0 m</div>
                            <div class="path-info-label">Distance</div>
                        </div>
                        <div class="path-info-item">
                            <div class="path-info-value" id="estimated-time">0 min</div>
                            <div class="path-info-label">Time</div>
                        </div>
                        <div class="path-info-item">
                            <div class="path-info-value" id="turn-count">0</div>
                            <div class="path-info-label">Turns</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 24px;">
                    <div class="card-header">
                        <i class="fas fa-bolt"></i>
                        <h3>Quick Destinations</h3>
                    </div>
                    <div class="quick-destinations">
                        <button class="quick-dest" data-room="lift1">Elevator</button>
                        <button class="quick-dest" data-room="stairs1">Stairs</button>
                        <button class="quick-dest" data-room="toilet1">Toilet</button>
                        <button class="quick-dest" data-room="room11">9303</button>
                        <button class="quick-dest" data-room="room40">9310</button>
                        <button class="quick-dest" data-room="room4">9336</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="map-container">
                <div class="map-header">
                    <h3><i class="fas fa-building"></i> Cantor Building - Level 3</h3>
                    <div class="map-controls">
                        <button class="map-control-btn" id="zoom-out" title="Zoom Out">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button class="map-control-btn" id="zoom-reset" title="Reset Zoom">
                            <i class="fas fa-expand-alt"></i>
                        </button>
                        <button class="map-control-btn" id="zoom-in" title="Zoom In">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="map-area" id="map-area">
                    <div class="map-content" id="map-content"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Simplified map data - removed comments and formatting
        const mapData = {
            "rooms": [
                {"id":"room1","name":"93343","x":80,"y":10,"width":130,"height":150,"type":"room"},
                {"id":"room2","name":"93341","x":80,"y":160,"width":130,"height":150,"type":"room"},
                {"id":"room3","name":"93340","x":80,"y":310,"width":130,"height":70,"type":"room"},
                {"id":"room4","name":"9336","x":80,"y":380,"width":130,"height":150,"type":"room"},
                {"id":"room5","name":"9335","x":80,"y":530,"width":130,"height":150,"type":"room"},
                {"id":"room6","name":"93342","x":280,"y":270,"width":100,"height":100,"type":"room"},
                {"id":"room7","name":"9339","x":280,"y":370,"width":100,"height":110,"type":"room"},
                {"id":"lift2","name":"Elevator 2","x":210,"y":40,"width":50,"height":90,"type":"elevator"},
                {"id":"lift1","name":"Elevator 1","x":260,"y":40,"width":50,"height":90,"type":"elevator"},
                {"id":"stairs1","name":"Stairs 93S3","x":310,"y":40,"width":70,"height":90,"type":"stairs"},
                {"id":"room8","name":"9300","x":380,"y":50,"width":50,"height":80,"type":"room"},
                {"id":"room9","name":"9301","x":430,"y":50,"width":50,"height":80,"type":"room"},
                {"id":"room10","name":"9304","x":480,"y":50,"width":50,"height":80,"type":"room"},
                {"id":"room11","name":"9303","x":530,"y":40,"width":140,"height":175,"type":"room"},
                {"id":"room12","name":"9305","x":670,"y":40,"width":140,"height":175,"type":"room"},
                {"id":"room13","name":"9306","x":810,"y":40,"width":140,"height":175,"type":"room"},
                {"id":"room14","name":"9307","x":950,"y":40,"width":140,"height":175,"type":"room"},
                {"id":"room15","name":"9309","x":1090,"y":10,"width":140,"height":130,"type":"room"},
                {"id":"toilet1","name":"Toilet 93T1","x":1090,"y":140,"width":60,"height":70,"type":"toilet"},
                {"id":"room16","name":"930B","x":1150,"y":140,"width":38,"height":50,"type":"room"},
                {"id":"room17","name":"9311","x":1090,"y":270,"width":70,"height":50,"type":"room"},
                {"id":"room18","name":"9312","x":1090,"y":320,"width":70,"height":50,"type":"room"},
                {"id":"room19","name":"9314","x":1090,"y":370,"width":50,"height":50,"type":"room"},
                {"id":"room20","name":"9316","x":1090,"y":420,"width":70,"height":50,"type":"room"},
                {"id":"toilet2","name":"Toilet 93T2","x":1090,"y":470,"width":75,"height":70,"type":"toilet"},
                {"id":"toilet3","name":"Toilet 93T5","x":280,"y":190,"width":60,"height":80,"type":"toilet"},
                {"id":"room21","name":"93T6","x":340,"y":230,"width":40,"height":40,"type":"room"},
                {"id":"room22","name":"9333","x":340,"y":480,"width":60,"height":50,"type":"room"},
                {"id":"toilet4","name":"Toilet 93T4","x":280,"y":480,"width":60,"height":50,"type":"toilet"},
                {"id":"room23","name":"9334","x":210,"y":570,"width":90,"height":50,"type":"room"},
                {"id":"stairs2","name":"Stairs 93S2","x":300,"y":570,"width":70,"height":90,"type":"stairs"},
                {"id":"room24","name":"9331","x":400,"y":480,"width":100,"height":60,"type":"room"},
                {"id":"room25","name":"9329","x":500,"y":480,"width":70,"height":60,"type":"room"},
                {"id":"room26","name":"9327","x":570,"y":480,"width":180,"height":60,"type":"room"},
                {"id":"room27","name":"9324","x":810,"y":480,"width":130,"height":60,"type":"room"},
                {"id":"room28","name":"9325","x":750,"y":480,"width":60,"height":60,"type":"room"},
                {"id":"room29","name":"9322","x":940,"y":480,"width":80,"height":60,"type":"room"},
                {"id":"room30","name":"9320","x":1020,"y":480,"width":70,"height":60,"type":"room"},
                {"id":"room31","name":"9332","x":370,"y":580,"width":70,"height":60,"type":"room"},
                {"id":"room32","name":"9330b","x":440,"y":580,"width":60,"height":60,"type":"room"},
                {"id":"room33","name":"9330","x":500,"y":580,"width":70,"height":60,"type":"room"},
                {"id":"room34","name":"9330a","x":570,"y":580,"width":60,"height":60,"type":"room"},
                {"id":"room35","name":"9328","x":630,"y":580,"width":40,"height":60,"type":"room"},
                {"id":"room36","name":"9326","x":670,"y":580,"width":80,"height":60,"type":"room"},
                {"id":"room37","name":"9323","x":750,"y":580,"width":220,"height":60,"type":"room"},
                {"id":"room38","name":"9321","x":970,"y":580,"width":120,"height":60,"type":"room"},
                {"id":"room39","name":"9319","x":1090,"y":580,"width":75,"height":30,"type":"room"},
                {"id":"room40","name":"9310","x":1230,"y":40,"width":140,"height":230,"type":"room"},
                {"id":"stairs3","name":"Stairs 93S1","x":1230,"y":270,"width":140,"height":40,"type":"stairs"},
                {"id":"room41","name":"9313","x":1230,"y":310,"width":75,"height":90,"type":"room"},
                {"id":"room42","name":"9315","x":1230,"y":400,"width":130,"height":230,"type":"room"},
                {"id":"room43","name":"9318","x":1090,"y":610,"width":140,"height":120,"type":"room"}
            ],
            "hallways": [
                {"id":"h1","x":480,"y":220,"width":730,"height":40,"orientation":"horizontal"},
                {"id":"h2","x":240,"y":540,"width":970,"height":40,"orientation":"horizontal"},
                {"id":"h3","x":460,"y":140,"width":40,"height":80,"orientation":"vertical"},
                {"id":"h4","x":230,"y":150,"width":250,"height":40,"orientation":"horizontal"},
                {"id":"h5","x":1180,"y":210,"width":40,"height":370,"orientation":"vertical"},
                {"id":"h6","x":230,"y":160,"width":40,"height":400,"orientation":"vertical"},
                {"id":"h7","x":380,"y":130,"width":100,"height":10,"orientation":"horizontal"},
                {"id":"h8","x":210,"y":130,"width":180,"height":10,"orientation":"horizontal"}
            ]
        };

        // State variables
        let startRoom = null, endRoom = null, currentPath = [], pathElements = [];
        let zoomLevel = 1, mapOffsetX = 0, mapOffsetY = 0;
        let hallwayNodes = [], connections = [], doorNodes = new Map();

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            processMapData();
            initializeMap();
            setupEventListeners();
            populateDropdowns();
            setupMapDragging();
            resetZoom();
        });

        function processMapData() {
            createEnhancedHallwayNetwork();
        }

        function createEnhancedHallwayNetwork() {
            hallwayNodes = []; connections = []; doorNodes.clear();

            // Create door nodes
            mapData.rooms.forEach(room => {
                const doorNodeId = `door_${room.id}`;
                let doorX, doorY;
                
                if (["toilet4","room22","room24","room25","room26","room28","room27","room29","room30","toilet2"].includes(room.id)) {
                    doorX = room.x + room.width / 2; doorY = room.y + room.height;
                } else if (["toilet3","room6","room7"].includes(room.id)) {
                    doorX = room.x; doorY = room.y + room.height / 2;
                } else if (["room17","room18","room19","room20"].includes(room.id)) {
                    doorX = room.x + room.width; doorY = room.y + room.height / 2;
                } else {
                    doorX = room.x + room.width / 2; doorY = room.y + room.height / 2;
                    if (room.x < 200) { doorX = room.x + room.width; }
                    else if (room.x > 1200) { doorX = room.x; }
                    else if (room.y < 100) { doorY = room.y + room.height; }
                    else { doorY = room.y; }
                }
                
                const doorNode = { id: doorNodeId, x: doorX, y: doorY, type: "door_node", roomId: room.id };
                hallwayNodes.push(doorNode);
                doorNodes.set(room.id, doorNode);
            });

            // Create hallway nodes
            mapData.hallways.forEach(hallway => {
                const nodes = [];
                const numNodes = Math.max(3, Math.floor(Math.max(hallway.width, hallway.height) / 50));
                
                if (hallway.orientation === "horizontal") {
                    const step = hallway.width / (numNodes - 1);
                    for (let i = 0; i < numNodes; i++) {
                        const node = { id: `${hallway.id}_${i}`, x: hallway.x + (i * step), y: hallway.y + hallway.height / 2, type: "hallway_node" };
                        nodes.push(node); hallwayNodes.push(node);
                    }
                } else {
                    const step = hallway.height / (numNodes - 1);
                    for (let i = 0; i < numNodes; i++) {
                        const node = { id: `${hallway.id}_${i}`, x: hallway.x + hallway.width / 2, y: hallway.y + (i * step), type: "hallway_node" };
                        nodes.push(node); hallwayNodes.push(node);
                    }
                }
                
                for (let i = 0; i < nodes.length - 1; i++) {
                    connections.push([nodes[i].id, nodes[i + 1].id]);
                }
            });

            // Connect doors to hallways
            mapData.rooms.forEach(room => {
                const doorNode = doorNodes.get(room.id);
                if (!doorNode) return;
                
                let nearestNode = null; let minDistance = Infinity;
                hallwayNodes.forEach(node => {
                    if (node.type === "hallway_node") {
                        const distance = Math.sqrt(Math.pow(node.x - doorNode.x, 2) + Math.pow(node.y - doorNode.y, 2));
                        if (distance < minDistance && distance < 150) {
                            minDistance = distance; nearestNode = node;
                        }
                    }
                });
                
                if (nearestNode) connections.push([doorNode.id, nearestNode.id]);
            });

            // Add direct connections
            const maxConnectionDistance = 100;
            hallwayNodes.forEach(node1 => {
                hallwayNodes.forEach(node2 => {
                    if (node1.id === node2.id) return;
                    const distance = Math.sqrt(Math.pow(node1.x - node2.x, 2) + Math.pow(node1.y - node2.y, 2));
                    if (distance < maxConnectionDistance) {
                        const alreadyConnected = connections.some(([a, b]) => (a === node1.id && b === node2.id) || (a === node2.id && b === node1.id));
                        if (!alreadyConnected) connections.push([node1.id, node2.id]);
                    }
                });
            });
        }

        function initializeMap() {
            const mapContent = document.getElementById('map-content');
            mapContent.innerHTML = '';
            
            // Create hallways
            mapData.hallways.forEach(hallway => {
                const el = document.createElement('div');
                el.className = 'hallway';
                el.style.left = `${hallway.x}px`; el.style.top = `${hallway.y}px`;
                el.style.width = `${hallway.width}px`; el.style.height = `${hallway.height}px`;
                mapContent.appendChild(el);
            });
            
            // Create rooms
            mapData.rooms.forEach(room => {
                const el = document.createElement('div');
                el.className = `room ${room.type}`;
                el.style.left = `${room.x}px`; el.style.top = `${room.y}px`;
                el.style.width = `${room.width}px`; el.style.height = `${room.height}px`;
                el.textContent = room.name;
                el.dataset.id = room.id;
                el.title = room.name;
                el.addEventListener('click', () => handleRoomClick(room.id));
                mapContent.appendChild(el);
            });
            
            // Create window
            const windowEl = document.createElement('div');
            windowEl.className = 'window';
            windowEl.style.left = '380px'; windowEl.style.top = '270px';
            windowEl.style.width = '710px'; windowEl.style.height = '210px';
            mapContent.appendChild(windowEl);
        }

        function setupEventListeners() {
            document.getElementById('find-path').addEventListener('click', findPath);
            document.getElementById('clear-path').addEventListener('click', clearPath);
            document.getElementById('zoom-in').addEventListener('click', () => zoomInOut(0.2));
            document.getElementById('zoom-out').addEventListener('click', () => zoomInOut(-0.2));
            document.getElementById('zoom-reset').addEventListener('click', resetZoom);
            
            document.querySelectorAll('.quick-dest').forEach(btn => {
                btn.addEventListener('click', function() {
                    const roomId = this.getAttribute('data-room');
                    handleQuickDestination(roomId);
                });
            });
            
            document.getElementById('start-room').addEventListener('change', function() {
                if (this.value) setStartRoom(this.value);
            });
            
            document.getElementById('end-room').addEventListener('change', function() {
                if (this.value) setEndRoom(this.value);
            });
        }

        function populateDropdowns() {
            const startSelect = document.getElementById('start-room');
            const endSelect = document.getElementById('end-room');
            
            const sortedRooms = [...mapData.rooms].sort((a, b) => a.name.localeCompare(b.name));
            sortedRooms.forEach(room => {
                const option1 = document.createElement('option');
                option1.value = room.id; option1.textContent = room.name;
                startSelect.appendChild(option1.cloneNode(true));
                endSelect.appendChild(option1);
            });
        }

        function showStatusMessage(message) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
        }

        function handleRoomClick(roomId) {
            if (!startRoom) {
                setStartRoom(roomId);
                document.getElementById('start-room').value = roomId;
            } else if (!endRoom) {
                setEndRoom(roomId);
                document.getElementById('end-room').value = roomId;
                findPath();
            } else {
                clearPath();
                setStartRoom(roomId);
                document.getElementById('start-room').value = roomId;
            }
        }

        function handleQuickDestination(roomId) {
            if (!startRoom) {
                setStartRoom(roomId);
                document.getElementById('start-room').value = roomId;
            } else if (!endRoom) {
                setEndRoom(roomId);
                document.getElementById('end-room').value = roomId;
                findPath();
            } else {
                clearPath();
                setStartRoom(roomId);
                document.getElementById('start-room').value = roomId;
            }
        }

        function setStartRoom(roomId) {
            document.querySelectorAll('.start-room').forEach(el => el.classList.remove('start-room'));
            startRoom = roomId;
            const element = document.querySelector(`[data-id="${roomId}"]`);
            if (element) element.classList.add('start-room');
        }

        function setEndRoom(roomId) {
            document.querySelectorAll('.end-room').forEach(el => el.classList.remove('end-room'));
            endRoom = roomId;
            const element = document.querySelector(`[data-id="${roomId}"]`);
            if (element) element.classList.add('end-room');
        }

        function findPath() {
            const startId = document.getElementById('start-room').value;
            const endId = document.getElementById('end-room').value;
            
            if (!startId || !endId) {
                showStatusMessage('Please select both start and destination locations');
                return;
            }
            
            if (startId === endId) {
                showStatusMessage('Start and destination cannot be the same');
                return;
            }
            
            setStartRoom(startId);
            setEndRoom(endId);
            
            try {
                const startNodeId = `door_${startId}`;
                const endNodeId = `door_${endId}`;
                const path = findShortestPath(startNodeId, endNodeId);
                
                if (path && path.length > 0) {
                    currentPath = path;
                    visualizePath(path);
                    updatePathInfo(path);
                    document.getElementById('path-info').style.display = 'block';
                } else {
                    showStatusMessage('No path found between selected locations');
                    document.getElementById('path-info').style.display = 'none';
                }
            } catch (error) {
                showStatusMessage('Error calculating route');
                console.error('Pathfinding error:', error);
            }
        }

        function findShortestPath(start, end) {
            const adj = {};
            connections.forEach(([a, b]) => {
                if (!adj[a]) adj[a] = [];
                if (!adj[b]) adj[b] = [];
                const nodeA = hallwayNodes.find(n => n.id === a);
                const nodeB = hallwayNodes.find(n => n.id === b);
                if (nodeA && nodeB) {
                    const distance = Math.sqrt(Math.pow(nodeA.x - nodeB.x, 2) + Math.pow(nodeA.y - nodeB.y, 2));
                    const penalty = (nodeA.type === 'door_node' || nodeB.type === 'door_node') ? 5 : 1;
                    adj[a].push({ node: b, distance: distance * penalty });
                    adj[b].push({ node: a, distance: distance * penalty });
                }
            });
            
            const distances = {}; const previous = {}; const openSet = new Set();
            hallwayNodes.forEach(node => { distances[node.id] = Infinity; previous[node.id] = null; });
            distances[start] = 0; openSet.add(start);
            
            while (openSet.size > 0) {
                let current = null; let minDistance = Infinity;
                for (const nodeId of openSet) {
                    if (distances[nodeId] < minDistance) { minDistance = distances[nodeId]; current = nodeId; }
                }
                
                if (current === end) {
                    const path = []; let node = current;
                    while (node !== null) { path.unshift(node); node = previous[node]; }
                    return path;
                }
                
                openSet.delete(current);
                if (!adj[current]) continue;
                
                for (const neighbor of adj[current]) {
                    const tentativeDistance = distances[current] + neighbor.distance;
                    if (tentativeDistance < distances[neighbor.node]) {
                        distances[neighbor.node] = tentativeDistance;
                        previous[neighbor.node] = current;
                        openSet.add(neighbor.node);
                    }
                }
            }
            return null;
        }

        function visualizePath(path) {
            clearPathVisuals();
            const mapContent = document.getElementById('map-content');
            const pointCoords = {};
            hallwayNodes.forEach(node => { pointCoords[node.id] = { x: node.x, y: node.y }; });
            
            for (let i = 0; i < path.length - 1; i++) {
                const from = pointCoords[path[i]];
                const to = pointCoords[path[i + 1]];
                if (from && to) drawPathSegment(from, to);
            }
        }

        function drawPathSegment(from, to) {
            const mapContent = document.getElementById('map-content');
            const dx = to.x - from.x;
            const dy = to.y - from.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * (180 / Math.PI);
            
            const line = document.createElement('div');
            line.className = 'path-line';
            line.style.left = `${from.x}px`;
            line.style.top = `${from.y}px`;
            line.style.width = `${distance}px`;
            line.style.transform = `rotate(${angle}deg)`;
            mapContent.appendChild(line);
            pathElements.push(line);
        }

        function updatePathInfo(path) {
            const pointCoords = {};
            hallwayNodes.forEach(node => { pointCoords[node.id] = { x: node.x, y: node.y }; });
            
            let totalDistance = 0;
            for (let i = 0; i < path.length - 1; i++) {
                const from = pointCoords[path[i]];
                const to = pointCoords[path[i + 1]];
                if (from && to) totalDistance += Math.sqrt(Math.pow(to.x - from.x, 2) + Math.pow(to.y - from.y, 2));
            }
            
            const distanceMeters = Math.round(totalDistance * 0.1);
            const timeMinutes = Math.round(distanceMeters / (1.4 * 60));
            
            document.getElementById('total-distance').textContent = `${distanceMeters}m`;
            document.getElementById('estimated-time').textContent = `${timeMinutes}min`;
        }

        function clearPath() {
            clearPathVisuals();
            startRoom = null; endRoom = null; currentPath = [];
            document.querySelectorAll('.start-room, .end-room').forEach(el => {
                el.classList.remove('start-room'); el.classList.remove('end-room');
            });
            document.getElementById('start-room').value = '';
            document.getElementById('end-room').value = '';
            document.getElementById('path-info').style.display = 'none';
        }

        function clearPathVisuals() {
            pathElements.forEach(el => { if (el.parentNode) el.parentNode.removeChild(el); });
            pathElements = [];
        }

        function setupMapDragging() {
            const mapArea = document.getElementById('map-area');
            mapArea.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            
            function startDrag(e) {
                if (e.target.closest('.map-control-btn') || e.target.closest('.room')) return;
                isDragging = true;
                dragStartX = e.clientX - mapOffsetX;
                dragStartY = e.clientY - mapOffsetY;
                mapArea.style.cursor = 'grabbing';
                e.preventDefault();
            }
            
            function drag(e) {
                if (!isDragging) return;
                mapOffsetX = e.clientX - dragStartX;
                mapOffsetY = e.clientY - dragStartY;
                updateMapPosition();
                e.preventDefault();
            }
            
            function stopDrag() {
                isDragging = false;
                mapArea.style.cursor = 'grab';
            }
        }

        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;

        function zoomInOut(delta) {
            const mapArea = document.getElementById('map-area');
            const rect = mapArea.getBoundingClientRect();
            const x = rect.width / 2;
            const y = rect.height / 2;
            const worldX = (x - mapOffsetX) / zoomLevel;
            const worldY = (y - mapOffsetY) / zoomLevel;
            const scaleFactor = 1 + delta;
            const newZoom = Math.max(0.3, Math.min(3, zoomLevel * scaleFactor));
            mapOffsetX = x - worldX * newZoom;
            mapOffsetY = y - worldY * newZoom;
            zoomLevel = newZoom;
            updateMapPosition();
        }

        function resetZoom() {
            const mapArea = document.getElementById('map-area');
            const mapWidth = 1550;
            const mapHeight = 750;
            const viewportWidth = mapArea.clientWidth;
            const viewportHeight = mapArea.clientHeight;
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                const mobileZoom = Math.min(viewportWidth / mapWidth, viewportHeight / mapHeight) * 0.85;
                zoomLevel = Math.max(0.5, Math.min(1.2, mobileZoom));
                mapOffsetX = (viewportWidth - mapWidth * zoomLevel) / 2;
                mapOffsetY = (viewportHeight - mapHeight * zoomLevel) / 3;
            } else {
                const zoomX = viewportWidth / mapWidth;
                const zoomY = viewportHeight / mapHeight;
                zoomLevel = Math.min(zoomX, zoomY) * 0.9;
                zoomLevel = Math.max(0.3, Math.min(1.5, zoomLevel));
                mapOffsetX = (viewportWidth - mapWidth * zoomLevel) / (2 * zoomLevel);
                mapOffsetY = (viewportHeight - mapHeight * zoomLevel) / (2 * zoomLevel);
            }
            updateMapPosition();
        }

        function updateMapPosition() {
            const mapContent = document.getElementById('map-content');
            mapContent.style.transform = `translate(${mapOffsetX}px, ${mapOffsetY}px) scale(${zoomLevel})`;
        }
    </script>
</body>
</html>




